{% extends "common/wrap.twig" %}

{% block title %}Заказы{% endblock %}

{% block content %}
    {% include "partials/header.twig" with {activeTab: 'orders', role: 'operator'} %}

    <div class="container">
        <div class="row">
            <div class="col-md-8 col-lg-9 mb-3 p-3">
                <a href="" type="button"
                   class="btn btn-outline-secondary btn-lg btn-block mb-3">
                    Новый заказ
                </a>
                <div class="list-group" id="orders-container">
                    {% include 'partials/loader.twig' %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        function mapOrders(orders) {
            let html = "";

            for (const order of orders) {
                let ready = true;

                html += `<div class="list-group-item flex-column align-items-start order">
                        <div class="d-flex w-100 justify-content-between mb-3">
                            <h3 class="display-4 m-0">
                                <small>#</small>
                                ${order.id % 1000}
                            </h3>
                            <p class="lead text-muted">${(new Date(order.time+"+00:00")).toLocaleTimeString()}</p>
                        </div>
                        <ul class="list-group list-group-flush mb-4">`;

                for (const foodpiece of order.foodpieces) {
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="foodpieceorder">
                                    <p class="lead mb-0">${foodpiece.name}</p>
                                </div>
                                <div class="btn-group-toggle"
                                     data-toggle="buttons">
                                    <label class="btn btn-outline-success ${foodpiece.ready?'active':''}">
                                        <input type="checkbox"
                                               autocomplete="off"
                                               >
                                        Готово
                                    </label>
                                </div>
                            </li>`;

                    if (!foodpiece.ready && ready) {
                        ready = false;
                    }
                }

                html += `</ul>
                        <div class="btn-group btn-group-toggle d-flex justify-content-end"
                             data-toggle="buttons" role="group">
                            <label class="btn btn-lg btn-outline-success ${ready?'':'disabled'} ${order.ready?'active':''}">
                                <input type="checkbox" autocomplete="off"> Готов
                            </label>
                            <label class="btn btn-lg btn-outline-success ${order.ready?'':'disabled'} ${order.archived?'active':''}">
                                <input type="checkbox" autocomplete="off"> Выдан
                            </label>
                        </div>
                    </div>`;
            }

            return html;

        }

        function loadOrders() {
            axios.get('/orders/json')
                .then(function (resp) {
                    document.getElementById('orders-container').innerHTML = mapOrders(resp.data);
                })
                .catch(function (e) { console.log(e)});
        }

        function initPage() {
            loadOrders()
        }
    </script>
{% endblock %}
